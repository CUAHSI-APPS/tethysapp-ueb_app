{% extends "ueb_app/base.html" %}
{% load staticfiles %}
{% load tethys_gizmos %}


{%block app_navigation%}
<h5><a href="/apps/ueb-app">Back to Mainpage</a></h5>
{%endblock%}


{% block app_content %}
<div id='title' style="margin-bottom:10px">
    <h3 style="color:#0073e6">UEB Model Inputs Preperation</h3>
    <p style="margin-bottom:20px">This service will help to retrieve data from different data sources and preprocess them as UEB model input files. These files will be shared as model instance resource in HydroShare
    </p>
</div>


<div id="main">
<div id='form' class='col-md-4'style="margin-bottom:30px">

    <form method="get" action='/apps/demo-app/toolbox/result'>
        {% csrf_token %}
        <div id="model domain">
            <h5>Watershed Bounding Box</h5>
            <table>
                <tr>
                    <td>{% gizmo text_input north_lat %}</td>
                    <td width="10px"/>
                    <td>{% gizmo text_input south_lat %}</td>
                </tr>
                <tr>
                    <td>{% gizmo text_input west_lon %}</td>
                    <td width="10px"/>
                    <td>{% gizmo text_input east_lon %}</td>
                </tr>
            </table>

            <h5>Watershed Outlet Point</h5>
            <table>
                <tr>
                    <td>{% gizmo text_input outlet_x %}</td>
                    <td width="10px"/>
                    <td>{% gizmo text_input outlet_y %}</td>
                </tr>
            </table>

            <h5>EPSG Code</h5>
            <div width="30%">{% gizmo select_input epsg_code %}</div>

            <h5>Model Simulation Time Period</h5>
            <table>
                <tr>
                    <td>{% gizmo date_picker start_time %}</td>
                    <td width="10px"/>
                    <td>{% gizmo date_picker end_time %}</td>
                </tr>
            </table>

            <h5>Cell size for reprojection (required)</h5>
            <table>
                <tr>
                    <td>{% gizmo text_input x_size %}</td>
                    <td width="10px"/>
                    <td>{% gizmo text_input y_size %}</td>
                </tr>
            </table>

            <h5>Cell size for model simulation (optional)</h5>
            <table>
                <tr>
                    <td>{% gizmo text_input dx_size %}</td>
                    <td width="10px"/>
                    <td>{% gizmo text_input dy_size %}</td>
                </tr>
            </table>

        </div>


        <input type="submit" value="Run Service" name='run-service' class="btn btn-success btn-lg">
    </form>
</div>

<div id='my-map' class="col-md-8">
    <h5>Draw watershed boundary and outlet point in map (US continent only)</h5>
    <div id="map" style="width:800px; height:600px"></div>

    <script>

      var allRectangles = [];
      var allMarkers = [];
      var map; // global variable
      var drawingManager;

      function initMap() {
        var mapDiv = document.getElementById('map');
        map = new google.maps.Map(mapDiv, {
            center: {lat: 37.09024, lng: -95.712891},
            zoom: 4
        });

        var drawingManager = new google.maps.drawing.DrawingManager({
            drawingControl: true,
            drawingControlOptions: {
              position: google.maps.ControlPosition.TOP_CENTER,
              drawingModes: [
                google.maps.drawing.OverlayType.MARKER,
                google.maps.drawing.OverlayType.RECTANGLE
              ]
             },
            rectangleOptions: {
                editable: true,
                draggable: true
            }
         });

         drawingManager.setMap(map);

         google.maps.event.addListener(drawingManager, 'rectanglecomplete', function (rectangle) {

            for (var i = 0; i < allRectangles.length; i++) {
                    allRectangles[i].setMap(null);
             };
            allRectangles.push(rectangle);

            var coordinates = (rectangle.getBounds());
            processDrawing(coordinates, 'rectangle');
            rectangle.addListener('bounds_changed', function () {
                var coordinates = (rectangle.getBounds());
                processDrawing(coordinates, "rectangle");
            });

         });

         google.maps.event.addListener(drawingManager, 'markercomplete', function (marker) {

            for (var i = 0; i < allMarkers.length; i++) {
                    allMarkers[i].setMap(null);
             };

            var coordinates = (marker.getPosition());
            processDrawing(coordinates, 'marker');
            allMarkers.push(marker);
         });

      } // end of initmap function



      function processDrawing (coordinates, shape) {
            if (shape == "rectangle"){
                // get coordinate value
                var bounds = {
                    north: parseFloat(coordinates.getNorthEast().lat()),
                    south: parseFloat(coordinates.getSouthWest().lat()),
                    east: parseFloat(coordinates.getNorthEast().lng()),
                    west: parseFloat(coordinates.getSouthWest().lng())
                };

                // update form fields
                $("#north_lat").val(bounds.north);
                $("#south_lat").val(bounds.south);
                $("#east_lon").val(bounds.east);
                $("#west_lon").val(bounds.west);
            }
            else {
                $("#outlet_x").val(coordinates.lng());
                $("#outlet_y").val(coordinates.lat());
            }
       } // end of processingDrawing function


       function drawMarkerOnTextChange(){
            var myLatLng = {lat: parseFloat($("#outlet_y").val()), lng: parseFloat($("#outlet_x").val())};

            // Delete previous drawings
            for (var i = 0; i < allMarkers.length; i++) {
                    allMarkers[i].setMap(null);
             };

            // Bounds validation
            var badInput = false;

            if (myLatLng.lat > 90 || myLatLng.lat < -90) {
                badInput = true;
            }

            if (myLatLng.lng > 180 || myLatLng.lng < -180) {
                badInput = true;
            }

            if (badInput || isNaN(myLatLng.lat) || isNaN(myLatLng.lng)) {
                return;
            }

            // Define the marker
            var marker = new google.maps.Marker({
                position: myLatLng,
                map: map
            });
            map.setCenter(marker.getPosition());

            allMarkers.push(marker);

        }

    </script>


    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCHOUQD9R_tLb6NKA22cuTTvF0j6X8wkgI&callback=initMap&libraries=drawing">
    </script>

    <script>
     $(document).ready(function() {
        // Draw marker on text change
        $("#outlet_x").bind('input', drawMarkerOnTextChange);
        $("#outlet_y").bind('input', drawMarkerOnTextChange);

       });
    </script>
</div>

</div>

{%endblock%}

{% block app_actions_override %}
{% endblock %}

{% block scripts %}
  {{ block.super }}
{% endblock %}

{% block content_dependent_styles %}
  {{ block.super }}
  <link href="{% static 'ueb_app/css/model_input.css' %}" rel="stylesheet"/>
{% endblock %}